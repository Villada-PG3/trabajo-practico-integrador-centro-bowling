{% extends 'bowl/navbar.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'bowl/tabla_puntuaciones.css' %}">
<style>
    .tabla-container { padding: 20px; color: #e8ecf1; }
    .score-shell {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(20,24,35,0.82);
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 16px;
        box-shadow: 0 18px 40px rgba(0,0,0,0.35);
        overflow: hidden;
    }
    .score-header {
        padding: 18px 20px;
        border-bottom: 1px solid rgba(255,255,255,0.12);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 700;
        letter-spacing: 0.5px;
    }
    .score-body { padding: 20px; }
    .pill-box {
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 12px;
        padding: 10px 14px;
        text-align: center;
    }

    .alert {
        background: rgba(76, 201, 91, 0.2);
        color: #d5ffdf;
        border: 1px solid rgba(76, 201, 91, 0.35);
        border-radius: 10px;
        text-align: center;
        margin: 10px 0;
        padding: 12px;
    }

    #tabla-puntuaciones {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: rgba(6, 10, 18, 0.8);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        overflow: hidden;
    }
    #tabla-puntuaciones thead th {
        background: rgba(255,255,255,0.06);
        color: #cfe6ff;
        padding: 12px 10px;
        text-align: center;
        font-weight: 600;
        border-right: 1px solid rgba(255,255,255,0.08);
    }
    #tabla-puntuaciones thead th:last-child { border-right: none; color: #7af0c9; }
    #tabla-puntuaciones tbody td {
        padding: 12px 10px;
        text-align: center;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        border-right: 1px solid rgba(255,255,255,0.05);
        font-size: 16px;
    }
    #tabla-puntuaciones tbody tr:nth-child(even) { background: rgba(255,255,255,0.02); }
    #tabla-puntuaciones tbody td:first-child {
        text-align: left;
        font-weight: 700;
        color: #ffffff;
    }
    #tabla-puntuaciones tbody td:last-child {
        font-size: 20px;
        font-weight: 800;
        color: #7af0c9;
        border-right: none;
        background: rgba(122, 240, 201, 0.08);
    }

    .frame-actual {
        background: rgba(255, 215, 99, 0.22) !important;
        font-weight: 700;
        border: 1px solid rgba(255, 215, 99, 0.4);
    }
    .turno-actual {
        background: rgba(255, 107, 107, 0.25) !important;
        color: #fff;
        font-weight: 700;
        box-shadow: inset 0 0 0 1px rgba(255, 107, 107, 0.45);
    }
    .turno-actual td:last-child {
        background: rgba(255, 107, 107, 0.35) !important;
        color: #fff !important;
    }

    .agregar-jugador-form {
        padding: 16px;
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 12px;
        margin: 20px 0;
    }
    .agregar-jugador-form form { display: flex; gap: 10px; }
    .agregar-jugador-form input[type="text"] {
        flex-grow: 1;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.2);
        background: rgba(0,0,0,0.3);
        color: #fff;
    }
    .btn-agregar {
        background: linear-gradient(135deg, #feca57, #ff9f43);
        color: #0f1117;
        font-weight: 800;
        padding: 12px 20px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.2s ease;
        box-shadow: 0 10px 20px rgba(0,0,0,0.25);
    }
    .btn-agregar:hover { transform: translateY(-2px); }

    .registro-box {
        background: linear-gradient(135deg, rgba(102,126,234,0.9), rgba(118,75,162,0.9));
        color: white;
        padding: 32px;
        border-radius: 18px;
        text-align: center;
        margin: 35px auto;
        max-width: 720px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.35);
    }
    #puntaje_input {
        font-size: 64px;
        width: 260px;
        padding: 18px;
        text-align: center;
        border: 3px solid rgba(255,255,255,0.6);
        border-radius: 14px;
        margin: 16px 0;
        color: #0f1117;
        font-weight: 800;
    }
    .registro-box button[type="submit"] {
        font-size: 26px !important;
        padding: 16px 60px !important;
        background: #fff !important;
        color: #5c6ac4 !important;
        border: none;
        border-radius: 14px;
        margin-top: 18px;
        font-weight: 800;
        box-shadow: 0 10px 20px rgba(0,0,0,0.25);
    }

    .ganador-box {
        background: linear-gradient(135deg, #f093fb, #f5576c);
        color: white;
        padding: 28px;
        border-radius: 18px;
        text-align: center;
        margin: 30px auto;
        max-width: 620px;
        box-shadow: 0 15px 30px rgba(0,0,0,0.4);
        border: 3px solid #ffd43b;
    }
    .ganador-box h1 { font-size: 38px; margin: 0 0 10px 0; }
    .ganador-box h2 { font-size: 60px; margin: 14px 0; color: #ffd43b; }
    .ganador-box h3 { font-size: 26px; margin: 10px 0; }
    .ganador-box > div {
        background: rgba(0,0,0,0.12);
        padding: 10px;
        border-radius: 10px;
        font-size: 18px;
    }

    .btn-start {
        font-size: 28px;
        padding: 18px 70px;
        background: linear-gradient(45deg, #00b894, #2ecc71);
        color: #fff;
        border: none;
        border-radius: 16px;
        box-shadow: 0 12px 24px rgba(0,0,0,0.25);
    }

    @media (max-width: 768px) {
        #tabla-puntuaciones { display: block; overflow-x: auto; white-space: nowrap; font-size: 14px; }
        .score-header { flex-direction: column; gap: 8px; text-align: center; }
    }
</style>
{% endblock %}

{% block content %}
<div class="tabla-container">
    <div class="score-shell">
        <div class="score-header">
            <div>CENTRO DE BOWLING – Reserva #{{ reserva_pk }}</div>
            <div class="pill-box">
                {% if partida_iniciada %}Partida en curso – Frame {{ frame_actual }}{% else %}En espera de iniciar{% endif %}
            </div>
        </div>
        <div class="score-body">

            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}

            {% if not partida_iniciada %}
                <div style="text-align:center; margin:40px 0;">
                    <form method="post">
                        {% csrf_token %}
                        <button name="empezar_partida" class="btn-start">
                            EMPEZAR PARTIDA
                        </button>
                    </form>
                </div>

                <div class="agregar-jugador-form" style="max-width:500px; margin:0 auto 30px;">
                    <h3 style="text-align:center; margin-bottom: 12px;">Agregar jugador</h3>
                    <form method="post">{% csrf_token %}
                        {{ jugador_form.nombre }}
                        <button name="agregar_jugador" class="btn-agregar">Agregar</button>
                    </form>
                </div>

            {% else %}
                <div class="pill-box" style="margin-bottom:20px;">
                    Partida en curso – Frame <strong>{{ frame_actual }}</strong>
                </div>
            {% endif %}

            <table id="tabla-puntuaciones">
                <thead>
                    <tr>
                        <th>JUGADOR</th>
                        {% for i in "1234567891" %}
                            <th>{% if forloop.counter == 10 %}10{% else %}{{ forloop.counter }}{% endif %}</th>
                        {% endfor %}
                        <th>TOTAL</th>
                    </tr>
                </thead>
                <tbody>
                    {% for j in jugadores_puntajes %}
                    <tr {% if j.es_turno_actual %}class="turno-actual"{% endif %}>
                        <td>
                            <strong>{{ j.nombre }}</strong>
                            {% if j.es_turno_actual %} turno{% endif %}
                        </td>
                        {% for p in j.puntajes %}
                        <td {% if p.frame == frame_actual %}class="frame-actual"{% endif %}
                            {% if p.es_actual %}style="background:#e74c3c; color:white;"{% endif %}>
                            {% if p.puntaje > 0 %}{{ p.puntaje }}{% else %}-{% endif %}
                        </td>
                        {% endfor %}
                        <td>{{ j.total }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="12" style="padding:60px; color:#95a5a6; font-style:italic;">No hay jugadores aún</td></tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if partida_terminada %}
                <div class="ganador-box">
                    <h1>¡PARTIDA TERMINADA!</h1>
                    <h2>{{ ganador.nombre }}</h2>
                    <h3>CAMPEÓN CON {{ ganador.total }} PUNTOS</h3>
                    <div style="margin-top:20px;">
                        {% for j in jugadores_puntajes %}
                            {% if j.nombre != ganador.nombre %}
                                <div style="margin:5px;">{{ j.nombre }} – {{ j.total }} puntos</div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
                <script>
                    confetti({ particleCount: 300, spread: 100, origin: { y: 0.6 } });
                    setInterval(() => {
                        confetti({ particleCount: 80, angle: 60, spread: 55, origin: { x: 0 } });
                        confetti({ particleCount: 80, angle: 120, spread: 55, origin: { x: 1 } });
                    }, 3000);
                </script>

            {% elif partida_iniciada %}
                <div class="registro-box">
                    <h1>TURNO DE: <span style="color:#ffd43b;">{{ jugador_actual.nombre }}</span></h1>
                    <h2>FRAME {{ frame_actual }}</h2>

                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="registrar_turno" value="1">
                        <input type="number" name="puntaje_turno" id="puntaje_input" min="0" max="10" autocomplete="off" autofocus placeholder="0">

                        <div style="margin:15px 0; font-style: italic; font-size: 15px;">
                            Ingresa los pinos derribados en este tiro (0-10)
                        </div>
                        
                        <button type="submit">REGISTRAR TIRO</button>
                    </form>
                </div>
            {% endif %}

        </div>
    </div>
</div>

<script>
document.querySelectorAll('[data-valor]').forEach(b => {
    b.onclick = () => {
        document.getElementById('puntaje_input').value = b.dataset.valor;
        document.getElementById('puntaje_input').focus();
    };
});
document.getElementById('puntaje_input')?.focus();
document.getElementById('puntaje_input')?.addEventListener('keypress', e => {
    if (e.key === 'Enter') {
        e.preventDefault(); 
    }
});
</script>
{% endblock %}
