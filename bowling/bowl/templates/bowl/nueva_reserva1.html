{% extends "bowl/navbar.html" %}
{% load static %}

{% block title %}Nueva Reserva - Space Bowling{% endblock %}

{% block extra_css %}
<style>
    .reserva-hero {
        text-align: center;
        padding: 50px 20px 20px;
        color: #ffffff;
    }
    .reserva-hero h2 { font-size: 2.4rem; margin-bottom: 10px; }
    .reserva-hero p { opacity: 0.85; margin: 0 auto 10px; }

    .reserva-shell { max-width: 1200px; margin: 0 auto; padding: 0 15px 40px; }
    .panel {
        background: rgba(20, 24, 35, 0.82);
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 16px;
        box-shadow: 0 18px 40px rgba(0,0,0,0.35);
        color: #e8ecf1;
    }
    .panel-header {
        padding: 16px 18px;
        border-bottom: 1px solid rgba(255,255,255,0.12);
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        letter-spacing: 0.5px;
    }
    .panel-body { padding: 20px; }

    .calendar-card input[type="date"] {
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.25);
        color: #fff;
        height: 52px;
        border-radius: 12px;
        text-align: center;
        width: 100%;
        font-size: 1.1rem;
    }
    .calendar-card input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
    .pill {
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.15);
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 0.95rem;
        color: #dfe7ee;
    }

    .slot-card {
        padding: 14px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(0,0,0,0.28);
        color: #e9f2fa;
        transition: transform 0.15s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .slot-card.available { border-color: rgba(76, 201, 91, 0.45); }
    .slot-card.unavailable { border-color: rgba(235, 87, 87, 0.35); opacity: 0.65; }
    .slot-card:hover { transform: translateY(-3px); box-shadow: 0 12px 24px rgba(0,0,0,0.25); }
    .slot-hour { font-weight: 800; letter-spacing: 0.5px; font-size: 1.05rem; }
    .slot-meta { font-size: 0.92rem; opacity: 0.9; }
    .btn-glow {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
        color: #fff;
        border: none;
        width: 100%;
        padding: 10px;
        border-radius: 10px;
        font-weight: 700;
        box-shadow: 0 10px 25px rgba(46, 204, 113, 0.35);
        transition: transform 0.12s ease, box-shadow 0.2s ease;
    }
    .btn-glow:hover { transform: translateY(-2px); box-shadow: 0 14px 30px rgba(46, 204, 113, 0.4); }
    .btn-ghost {
        width: 100%;
        padding: 10px;
        border-radius: 10px;
        border: 1px dashed rgba(255,255,255,0.3);
        color: #cdd7e0;
        background: transparent;
    }

    /* Modal */
    .modal-content {
        background: rgba(20,24,35,0.95);
        color: #e8eef5;
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 14px;
        box-shadow: 0 20px 45px rgba(0,0,0,0.35);
    }
    .modal-header { border: none; }
    .modal-title { font-weight: 700; letter-spacing: 0.4px; }
    .modal-body h4 { color: #9ad5ff; margin-bottom: 6px; }
    .modal-body h3 { color: #fff; margin-bottom: 16px; }
    .form-select {
        background: rgba(255,255,255,0.08);
        color: #fff;
        border: 1px solid rgba(255,255,255,0.2);
    }
    .form-select option { color: #0f1117; }
    .modal-footer {
        border: none;
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }
    .btn-cancel {
        flex: 1;
        background: rgba(255,255,255,0.08);
        color: #cdd7e0;
        border: 1px solid rgba(255,255,255,0.18);
        border-radius: 12px;
        padding: 12px 14px;
        font-weight: 700;
    }
    .btn-cancel:hover { background: rgba(255,255,255,0.12); }
    .btn-confirm {
        flex: 1.2;
        background: linear-gradient(135deg, #2ecc71, #1abc9c);
        color: #0b0f18;
        border: none;
        border-radius: 12px;
        padding: 12px 14px;
        font-weight: 800;
        box-shadow: 0 12px 28px rgba(26, 188, 156, 0.35);
        transition: transform 0.12s ease, box-shadow 0.2s ease;
    }
    .btn-confirm:hover { transform: translateY(-1px); box-shadow: 0 16px 30px rgba(26, 188, 156, 0.45); }
    .btn-confirm:active { transform: translateY(1px); }

    @media (max-width: 768px) {
        .slot-card { padding: 12px; }
    }
</style>
{% endblock %}

{% block content %}

<div class="reserva-hero">
    <h2>Reservar Pista de Bowling</h2>
    <p>Eleg√≠ el d√≠a y horario, y confirm√° tu pista en segundos.</p>
</div>

<div class="reserva-shell">
    <div class="row g-4">
        <!-- Calendario -->
        <div class="col-lg-4">
            <div class="panel calendar-card">
                <div class="panel-header">üìÖ Selecciona el d√≠a</div>
                <div class="panel-body">
                    <form method="get" class="mb-3">
                        <input type="date" 
                               name="fecha" 
                               id="fecha-input"
                               value="{{ fecha_seleccionada|date:'Y-m-d' }}" 

                               onchange="this.form.submit()"
                               required>
                    </form>
                    <div class="pill text-center">
                        Horario disponible: <strong>14:00 - 23:00 hs</strong><br>
                        Reservas cada hora en punto
                    </div>
                </div>
            </div>
        </div>

        <!-- Horarios del d√≠a seleccionado -->
        <div class="col-lg-8">
            <div class="panel">
                <div class="panel-header">
                    {{ fecha_seleccionada|date:"l d" }} de {{ fecha_seleccionada|date:"F Y" }}
                </div>
                <div class="panel-body">
                    {% if horarios_disponibilidad %}
                        <div class="row g-3">
                            {% for slot in horarios_disponibilidad %}
                                <div class="col-6 col-md-4 col-lg-3">
                                    <div class="slot-card {% if slot.disponible %}available{% else %}unavailable{% endif %}">
                                        <div class="slot-hour {% if slot.disponible %}text-success{% else %}text-danger{% endif %}">
                                            {{ slot.hora }}
                                        </div>
                                        <div class="slot-meta mb-2">
                                            {% if slot.disponible %}
                                                <strong>{{ slot.cantidad }}</strong> pista{{ slot.cantidad|pluralize }} disponibles
                                            {% else %}
                                                Completo
                                            {% endif %}
                                        </div>
                                        {% if slot.disponible %}
                                            <button type="button"
                                                    class="btn-glow btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#modalReserva"
                                                    data-fecha="{{ fecha_seleccionada|date:'Y-m-d' }}"
                                                    data-hora="{{ slot.hora }}"
                                                    data-pistas='{{ slot.pistas_json|safe }}'>
                                                Reservar
                                            </button>
                                        {% else %}
                                            <button class="btn-ghost btn-sm" disabled>
                                                No disponible
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-warning text-center">
                            No hay horarios disponibles para este d√≠a.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para elegir pista -->
<div class="modal fade" id="modalReserva" tabindex="-1" aria-labelledby="modalReservaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalReservaLabel">Confirmar Reserva</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <h4 id="modal-fecha"></h4>
                        <h3 id="modal-hora" class="fw-bold"></h3>
                    </div>

                    <div class="mb-3">
                        <label for="id_pista" class="form-label fw-bold">Elige tu pista:</label>
                        <select name="pista" id="id_pista" class="form-select form-select-lg" required>
                            <option value="">-- Selecciona una pista disponible --</option>
                        </select>
                    </div>

                    <input type="hidden" name="fecha" id="id_fecha">
                    <input type="hidden" name="hora" id="id_hora">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn-confirm">Confirmar Reserva</button>
                </div>
            </form>
        </div>
    </div>
</div>



<script>
document.querySelectorAll('[data-bs-toggle="modal"]').forEach(btn => {
    btn.addEventListener('click', function () {
        const fecha = this.getAttribute('data-fecha');
        const hora = this.getAttribute('data-hora');
        const pistasJsonRaw = this.getAttribute('data-pistas');

        const fechaObj = new Date(fecha + 'T12:00');
        document.getElementById('modal-fecha').textContent = fechaObj.toLocaleDateString('es-ES', {
            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
        }).replace(/^\w/, c => c.toUpperCase());

        document.getElementById('modal-hora').textContent = hora;
        document.getElementById('id_fecha').value = fecha;
        document.getElementById('id_hora').value = hora;

        const select = document.getElementById('id_pista');
        select.innerHTML = '<option value=\"\">-- Selecciona una pista disponible --</option>';

        let pistas = [];
        try {
            pistas = JSON.parse(pistasJsonRaw);
        } catch (e) {
            console.error("Error parseando JSON de pistas", e);
            select.innerHTML += '<option value=\"\">Error cargando pistas</option>';
            return;
        }

        pistas.forEach(pista => {
            const opt = document.createElement('option');
            opt.value = pista.pk;
            const tipoLabel = pista.tipo || 'Tipo desconocido';
            const precioLabel = pista.precio !== undefined ? `($${pista.precio})` : '';
            opt.textContent = `Pista ${pista.numero} ‚Äì ${tipoLabel} ${precioLabel}`;
            select.appendChild(opt);
        });
    });
});
</script>

{% endblock %}